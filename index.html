<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self';">
    <meta name="description" content="Sistema de Rifa - Amenazas Avanzadas">
    <meta name="author" content="Rafael Guevara">
    <title>RIFA AMENAZAS AVANZADAS - Raffle Selection System</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Particles Background -->
    <div id="tsparticles"></div>

    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="header-brand">
                    <svg class="shield-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                    <div class="header-titles">
                        <h1 class="header-title"><span class="title-highlight">RIFA</span> AMENAZAS AVANZADAS</h1>
                        <span class="header-subtitle">La mejor Ã¡rea</span>
                    </div>
                </div>
                <button class="btn btn-abort" id="abort-button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    ABORT / RESET
                </button>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Stage 1: File Upload -->
            <section id="upload-section" class="section active">
                <div class="section-header">
                    <h2 class="section-title">Initialize Session</h2>
                    <p class="section-subtitle">Upload dataset to begin the random distribution protocol.</p>
                </div>

                <div class="upload-panel">
                    <div class="upload-grid">
                        <!-- Participants Upload -->
                        <div class="upload-card">
                            <div class="upload-card-header">
                                <svg class="upload-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                </svg>
                                <span class="upload-card-title">PARTICIPANTS DATABASE (NAME, TICKET)</span>
                            </div>
                            <div class="drop-zone" id="participants-drop-zone">
                                <div class="drop-zone-content">
                                    <p class="drop-zone-text">Drop CSV or Click to Upload</p>
                                </div>
                                <input type="file" id="participants-file" accept=".csv" class="file-input">
                            </div>
                            <div class="upload-status-bar">
                                <span class="status-label">STATUS: <span class="status-value" id="participants-status-text">WAITING</span></span>
                                <span class="count-label">COUNT: <span class="count-value" id="participants-count-value">0</span></span>
                            </div>
                        </div>

                        <!-- Prizes Upload -->
                        <div class="upload-card">
                            <div class="upload-card-header">
                                <svg class="upload-card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="8" r="6"></circle>
                                    <path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"></path>
                                </svg>
                                <span class="upload-card-title">PRIZE INVENTORY (PRIZE NAME)</span>
                            </div>
                            <div class="drop-zone" id="prizes-drop-zone">
                                <div class="drop-zone-content">
                                    <p class="drop-zone-text">Drop CSV or Click to Upload</p>
                                </div>
                                <input type="file" id="prizes-file" accept=".csv" class="file-input">
                            </div>
                            <div class="upload-status-bar">
                                <span class="status-label">STATUS: <span class="status-value" id="prizes-status-text">WAITING</span></span>
                                <span class="count-label">COUNT: <span class="count-value" id="prizes-count-value">0</span></span>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-initialize" id="initialize-button" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        INITIALIZE SEQUENCE
                    </button>
                </div>

                <div class="data-requirements">
                    <h4>DATA FORMAT REQUIREMENTS:</h4>
                    <ol>
                        <li>Participants.csv: Column A = Name, Column B = Ticket Number</li>
                        <li>Prizes.csv: Column A = Prize Name</li>
                    </ol>
                </div>

                <div class="error-message" id="upload-error"></div>
            </section>

            <!-- Stage 2: Validation & Preview -->
            <section id="preview-section" class="section">
                <div class="section-header">
                    <h2 class="section-title">Data Validation</h2>
                    <p class="section-subtitle">Review loaded datasets before initiating distribution sequence.</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="participants-count">0</div>
                        <div class="stat-label">PARTICIPANTS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="prizes-count">0</div>
                        <div class="stat-label">TOTAL PRIZES</div>
                    </div>
                </div>

                <div class="warning-message" id="preview-warning"></div>

                <div class="preview-grid">
                    <div class="preview-card">
                        <h3>Participants Preview</h3>
                        <div class="preview-list" id="participants-preview"></div>
                    </div>
                    <div class="preview-card">
                        <h3>Prize Inventory</h3>
                        <div class="preview-list" id="prizes-preview"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" id="back-to-upload">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                        BACK
                    </button>
                    <button class="btn btn-primary" id="start-raffle" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        START SEQUENCE
                    </button>
                </div>
            </section>

            <!-- Stage 3: Raffle Execution -->
            <section id="raffle-section" class="section">
                <div class="raffle-header">
                    <div class="live-indicator" id="live-indicator">
                        <span class="live-dot"></span>
                        LIVE EXECUTION
                    </div>
                    <div class="progress-counter" id="progress-counter">PROGRESS: 0 / 0</div>
                </div>

                <div class="raffle-layout">
                    <main class="raffle-main">
                        <div class="raffle-display">
                            <div class="current-prize" id="current-prize">
                                <span class="prize-label">CURRENT PRIZE:</span>
                                <span class="prize-name" id="current-prize-name">-</span>
                            </div>

                            <div class="slot-machine" id="slot-machine">
                                <div class="slot-content" id="slot-content"></div>
                            </div>

                            <div class="winner-reveal" id="winner-reveal"></div>

                            <button class="btn btn-draw" id="draw-button" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polygon points="10 8 16 12 10 16 10 8"></polygon>
                                </svg>
                                <span id="draw-button-text">DRAW WINNER</span>
                            </button>
                        </div>

                        <div class="statistics-bar" id="statistics-bar">
                            <div class="stat-item">
                                <span class="stat-item-label">PARTICIPANTS</span>
                                <span class="stat-item-value" id="stat-participants">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-item-label">TOTAL PRIZES</span>
                                <span class="stat-item-value" id="stat-prizes">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-item-label">WINNERS</span>
                                <span class="stat-item-value" id="stat-winners">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-item-label">REMAINING</span>
                                <span class="stat-item-value" id="stat-remaining">0</span>
                            </div>
                        </div>

                        <!-- Completion Screen (hidden by default) -->
                        <div class="completion-screen" id="completion-screen">
                            <div class="completion-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9 12l2 2 4-4"></path>
                                </svg>
                            </div>
                            <h2 class="completion-title">Sequence Complete</h2>
                            <p class="completion-subtitle">All prizes have been allocated.</p>
                            <button class="btn btn-download-report" id="download-final-report">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                DOWNLOAD FINAL REPORT
                            </button>
                        </div>
                    </main>

                    <aside class="audit-log" id="audit-log">
                        <div class="audit-log-header">
                            <div class="audit-log-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                </svg>
                                Audit Log
                            </div>
                            <button class="btn-icon" id="audit-download" title="Download Audit Log">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="audit-entries" id="audit-entries">
                            <div class="audit-empty">No winners yet</div>
                        </div>
                    </aside>
                </div>
            </section>

            <!-- Stage 4: Results (keeping for backwards compatibility) -->
            <section id="results-section" class="section">
                <div class="section-header">
                    <h2 class="section-title">Distribution Complete</h2>
                    <p class="section-subtitle">Final allocation results are ready for export.</p>
                </div>

                <div class="results-layout">
                    <div class="results-main">
                        <div class="results-table-container">
                            <table class="results-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Winner</th>
                                        <th>Ticket</th>
                                        <th>Prize</th>
                                    </tr>
                                </thead>
                                <tbody id="results-tbody">
                                </tbody>
                            </table>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-secondary" id="download-results">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                DOWNLOAD CSV
                            </button>
                            <button class="btn btn-primary" id="new-raffle">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                                </svg>
                                NEW SESSION
                            </button>
                        </div>
                    </div>

                    <aside class="audit-log results-audit-log" id="results-audit-log">
                        <div class="audit-log-header">
                            <div class="audit-log-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                </svg>
                                Audit Log
                            </div>
                            <button class="btn-icon" id="results-audit-download" title="Download Audit Log">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="audit-entries" id="results-audit-entries">
                        </div>
                    </aside>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Amenazas Avanzadas Selection System.</p>
        </div>
    </footer>

    <!-- Abort Confirmation Modal -->
    <div class="modal-overlay" id="abort-modal">
        <div class="modal">
            <div class="modal-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <h3>Confirm Abort</h3>
            </div>
            <p class="modal-body">Are you sure you want to abort the current sequence? All progress will be lost.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="abort-cancel">CANCEL</button>
                <button class="btn btn-danger" id="abort-confirm">ABORT</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles-slim@2.12.0/tsparticles.slim.bundle.min.js"></script>

    <script src="js/utils.js"></script>
    <script src="js/particles-config.js"></script>
    <script src="js/csv-parser.js"></script>
    <script src="js/raffle-engine.js"></script>
    <script src="js/animation.js"></script>
    <script src="js/ui-controller.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
